# 数据库与安全组绑定流程

## 三、正确的新建数据库流程（一步一步）

### ✅ Step 1：先建 RDS 专用安全组

**路径：**
VPC → 安全组 → 创建安全组

**配置：**

- **名称**：rds-sg
- **VPC**：nest-vpc（一定要选这个）
- **入站规则**：
  - **类型**：PostgreSQL
  - **端口**：5432
  - **来源**：lambda-sg（选择安全组，不是 IP）

> ⚠️ 这里如果你还没建 lambda-sg，可以先空着，后面补。

### ✅ Step 2：创建数据库（RDS）

**在 创建 RDS 的页面：**

**网络配置部分：**

- **VPC**：nest-vpc
- **子网组**：选择 **私有子网**（你那 3 个 private subnet 正是干这个用的）
- **公共访问**：❌ 否（No）
- **安全组**：✅ 选择 **rds-sg**

> ❗不要选 default
> ❗不要选 lambda-sg
> ❗不要选 0.0.0.0/0

### ✅ Step 3：给 Lambda 绑定安全组

**在 Lambda 配置里：**
Lambda → Configuration → VPC

- **子网**：选择 private subnet
- **安全组**：选择 **lambda-sg**

### ✅ Step 4：形成最终访问链路（这是闭环）

```
Internet
  ↓
API Gateway / Nginx
  ↓
Lambda（lambda-sg）
  ↓  允许 5432
RDS（rds-sg）
```

**任何不在 lambda-sg 里的资源：**

- ❌ 连不上数据库
- ❌ 扫描不到端口
- ❌ 即使在同一 VPC 也不行

## 四、为什么不能“数据库直接选 lambda 的安全组？”

这是很多人第一次都会犯的错误，我直接给你原因：

### ❌ 错误做法

- RDS 绑定 `lambda-sg`
- `lambda-sg` 再允许自己访问自己

### ❌ 为什么错

- 安全组是 **“被绑定资源的防火墙”**
- RDS 和 Lambda 角色不同

**混用会导致：**

- 权限边界不清
- 以后扩展（比如再加 EC2）会非常混乱
- 安全审计直接不合格

**AWS 官方也明确建议：**
数据库必须有独立安全组
