name: Deploy Backend (prod)

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      AWS_REGION: ap-southeast-2
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Install SAM CLI
        run: |
          python3 -m pip install --user aws-sam-cli
          echo "$HOME/.local/bin" >> "$GITHUB_PATH"
          sam --version

      - name: Build
        run: sam validate && sam build

      - name: Deploy
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          DB_SECURITY_GROUP_ID: ${{ secrets.DB_SECURITY_GROUP_ID }}
          LAMBDA_SECURITY_GROUP_ID: ${{ secrets.LAMBDA_SECURITY_GROUP_ID }}
        run: |
          DATABASE_URL_FIXED="$DATABASE_URL"
          echo "::add-mask::$DATABASE_URL_FIXED"
          export DATABASE_URL_FIXED
          DB_HOST="$(python3 -c 'import os,urllib.parse; print(urllib.parse.urlparse(os.environ["DATABASE_URL_FIXED"]).hostname or "")')"
          if [ -n "${DB_SECURITY_GROUP_ID:-}" ]; then
            DB_SG_ID="$DB_SECURITY_GROUP_ID"
          else
            DB_SG_ID="$(aws rds describe-db-instances \
              --region "$AWS_REGION" \
              --query "DBInstances[?Endpoint.Address=='${DB_HOST}'].VpcSecurityGroups[0].VpcSecurityGroupId" \
              --output text)"
          fi
          if [ -z "$DB_SG_ID" ] || [ "$DB_SG_ID" = "None" ]; then
            echo "Could not resolve DB security group from RDS endpoint: $DB_HOST" 1>&2
            aws rds describe-db-instances --region "$AWS_REGION" --query "DBInstances[].Endpoint.Address" --output table 1>&2
            exit 1
          fi
          PARAM_OVERRIDES=("DatabaseUrl=$DATABASE_URL_FIXED" "DatabaseSecurityGroupId=$DB_SG_ID")
          if [ -n "${LAMBDA_SECURITY_GROUP_ID:-}" ]; then
            PARAM_OVERRIDES+=("LambdaSecurityGroupId=$LAMBDA_SECURITY_GROUP_ID")
          fi
          sam deploy \
            --config-env prod \
            --no-confirm-changeset \
            --no-fail-on-empty-changeset \
            --parameter-overrides "${PARAM_OVERRIDES[@]}"

      - name: Run Prisma migrations (in VPC)
        run: |
          FUNCTION_NAME="$(aws cloudformation describe-stacks \
            --stack-name sam-aws-nest-backend-prod \
            --region "$AWS_REGION" \
            --query "Stacks[0].Outputs[?OutputKey=='MigrationFunctionName'].OutputValue" \
            --output text)"
          aws lambda invoke \
            --function-name "$FUNCTION_NAME" \
            --payload '{}' \
            --cli-binary-format raw-in-base64-out \
            /tmp/migrate.json
          cat /tmp/migrate.json

      - name: Print stack outputs
        run: |
          aws cloudformation describe-stacks \
            --stack-name sam-aws-nest-backend-prod \
            --region "$AWS_REGION" \
            --query 'Stacks[0].Outputs' \
            --output table
